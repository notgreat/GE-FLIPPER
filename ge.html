<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OSRS Flip Advisor</title>

<style>
:root{
  --bg:#0b0b0c;
  --panel:#121214;
  --text:#f5f5f7;
  --muted:#a1a1a6;
  --line:rgba(255,255,255,.10);
  --green:#30d158;
  --yellow:#ffd60a;
  --red:#ff453a;
  --radius:18px;
  --shadow:0 24px 70px rgba(0,0,0,.55);
  --mono:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;
}
.wrap{max-width:1100px;margin:0 auto;padding:22px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.coin{
  width:44px;height:44px;border-radius:12px;
  background:#1a1a1c;border:1px solid var(--line);
  display:grid;place-items:center;
}
.coin img{width:36px;height:36px}
.card{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}
.controls{
  padding:14px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}
.field{
  display:flex;gap:10px;align-items:center;
  background:#0f0f11;border:1px solid var(--line);
  padding:10px 12px;border-radius:14px;
}
.field input{
  background:none;border:0;color:var(--text);
  outline:none;font-size:15px;width:160px;
}
.btn{
  padding:10px 12px;border-radius:14px;
  background:#1b1b1e;border:1px solid var(--line);
  color:var(--text);cursor:pointer;font-weight:600;
}
.btn.primary{background:rgba(48,209,88,.18);border-color:rgba(48,209,88,.4)}
.status{padding:10px 14px;border-top:1px solid var(--line);color:var(--muted)}
.tableWrap{overflow:auto;border-top:1px solid var(--line)}
table{width:100%;border-collapse:collapse;min-width:980px}
th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.08);white-space:nowrap}
th{text-align:left;font-size:12px;text-transform:uppercase;color:#cfcfd3}
.right{text-align:right}
.mono{font-family:var(--mono)}
.star{cursor:pointer;margin-right:8px;color:#ffd60a;font-size:16px}
.star.off{opacity:.35}
.pill{
  padding:5px 9px;border-radius:999px;
  font-size:12px;border:1px solid var(--line)
}
.green{color:var(--green)}
.yellow{color:var(--yellow)}
.red{color:var(--red)}
</style>
</head>

<body>
<div class="wrap">

<div class="header">
  <div class="coin">
    <img src="https://www.clipartmax.com/middle/m2i8A0d3Z5G6G6Z5_coins-250-detail-runescape-gp-png/" />
  </div>
  <h2>OSRS Flip Advisor</h2>
</div>

<div class="card">
  <div class="controls">
    <div class="field">
      <label>GP</label>
      <input id="gp" placeholder="1m, 1.5m, 750k" />
    </div>
    <div class="field">
      <label>Search</label>
      <input id="search" placeholder="Any item…" />
    </div>
    <button class="btn primary" onclick="loadFlips()">Refresh</button>
    <button class="btn" onclick="toggleSort()">Sort: ROI</button>
    <button class="btn" onclick="toggleOvernight()">Overnight: Off</button>
  </div>

  <div class="status" id="status">Ready.</div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th class="right">Buy</th>
          <th class="right">Sell</th>
          <th class="right">Net</th>
          <th class="right">ROI</th>
          <th class="right">Vol</th>
          <th class="right">Limit</th>
          <th class="right">Fill</th>
          <th class="right">Result</th>
        </tr>
      </thead>
      <tbody id="results"></tbody>
    </table>
  </div>
</div>
</div>

<script>
const FAVORITES_KEY="osrs_flip_favorites";
const MIN_VOLUME=50;
const MAX_VOL1H=5;

let sortMode="roi";
let overnightMode=false;

function getFavs(){return new Set(JSON.parse(localStorage.getItem(FAVORITES_KEY)||"[]"))}
function saveFavs(f){localStorage.setItem(FAVORITES_KEY,JSON.stringify([...f]))}

function parseGP(v){
  v=v.toLowerCase().replace(/,/g,"").trim();
  if(v.endsWith("m"))return+v.slice(0,-1)*1e6;
  if(v.endsWith("k"))return+v.slice(0,-1)*1e3;
  return+v||0;
}
function fmt(n){return n.toLocaleString()}
function roiClass(r){return r>=.06?"green":r>=.03?"yellow":"red"}

function toggleSort(){
  sortMode=sortMode==="roi"?"profit":"roi";
  event.target.textContent="Sort: "+(sortMode==="roi"?"ROI":"Profit");
  loadFlips();
}
function toggleOvernight(){
  overnightMode=!overnightMode;
  event.target.textContent="Overnight: "+(overnightMode?"On":"Off");
  loadFlips();
}

async function loadFlips(){
  const gp=parseGP(document.getElementById("gp").value);
  if(!gp)return alert("Enter GP");

  const search=(document.getElementById("search").value||"").toLowerCase();
  const favs=getFavs();
  document.getElementById("status").textContent="Loading...";

  const [latest,five,mapping]=await Promise.all([
    fetch("https://prices.runescape.wiki/api/v1/osrs/latest").then(r=>r.json()),
    fetch("https://prices.runescape.wiki/api/v1/osrs/5m").then(r=>r.json()),
    fetch("https://prices.runescape.wiki/api/v1/osrs/mapping").then(r=>r.json())
  ]);

  const map={}; mapping.forEach(i=>map[i.id]={name:i.name,limit:i.limit||0});
  const rows=[];

  for(const id in latest.data){
    const m=map[id]; if(!m)continue;
    if(search && !m.name.toLowerCase().includes(search)) continue;

    const L=latest.data[id],V=five.data[id]||{};
    const buy=L.low,sell=L.high;

    let reason=null;

    if(!buy||!sell||sell<=buy||buy<100) reason="No margin";
    const vol=Math.min(V.lowPriceVolume||0,V.highPriceVolume||0);
    if(!reason && vol<MIN_VOLUME) reason="Low volume";

    const net=sell-buy-Math.floor(sell*.01);
    const roi=net/buy;
    const vol1h=Math.max(
      Math.abs(V.lowPriceChangePercent||0),
      Math.abs(V.highPriceChangePercent||0)
    );
    if(!reason && vol1h>MAX_VOL1H) reason="High volatility";

    const qty=Math.min(Math.floor(gp/buy),m.limit||0);
    if(!reason && qty<=0) reason="Insufficient GP";

    if(!search && reason) continue;

    if(overnightMode && !reason){
      if(vol<200||vol1h>2||m.limit<500||net<buy*.01||buy<5000)
        reason="Not ideal overnight";
    }

    const score = (!reason && overnightMode)
      ? net*qty*(1-(vol1h/5))
      : 0;

    rows.push({
      name:m.name,buy,sell,net,roi,vol,limit:m.limit||0,
      fill:vol?Math.ceil(m.limit/vol*5):"-",
      profit:net*qty,
      fav:favs.has(m.name),
      reason,
      score
    });
  }

  rows.sort((a,b)=>{
    if(a.fav!==b.fav)return a.fav?-1:1;
    if(overnightMode)return (b.score||0)-(a.score||0);
    return sortMode==="roi"?b.roi-a.roi:b.profit-a.profit;
  });

  const tbody=document.getElementById("results");
  tbody.innerHTML="";

  rows.slice(0,60).forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>
        <span class="star ${r.fav?"":"off"}" data="${r.name}">${r.fav?"★":"☆"}</span>
        ${r.name}
      </td>
      <td class="right mono">${r.buy?fmt(r.buy):"-"}</td>
      <td class="right mono">${r.sell?fmt(r.sell):"-"}</td>
      <td class="right mono">${r.net?fmt(r.net):"-"}</td>
      <td class="right mono">${r.net?`<span class="pill ${roiClass(r.roi)}">${(r.roi*100).toFixed(2)}%</span>`:"-"}</td>
      <td class="right mono">${fmt(r.vol||0)}</td>
      <td class="right mono">${fmt(r.limit||0)}</td>
      <td class="right mono">${r.fill}</td>
      <td class="right mono">
        ${r.reason
          ? `<span class="pill red">${r.reason}</span>`
          : `<span class="pill green">${fmt(r.profit)}</span>`
        }
      </td>`;
    tbody.appendChild(tr);
  });

  document.querySelectorAll(".star").forEach(s=>{
    s.onclick=()=>{
      const f=getFavs(),n=s.getAttribute("data");
      f.has(n)?f.delete(n):f.add(n);
      saveFavs(f); loadFlips();
    };
  });

  document.getElementById("status").textContent=
    `Showing ${Math.min(60,rows.length)} items for ${fmt(gp)} gp`;
}
</script>
</body>
</html>
